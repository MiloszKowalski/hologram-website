<script>
  import { atom } from "nanostores";
  import { isIntroFinished, isIosOrientationAllowed, isMenuVisible } from "../../store/animationStore";
  import { ScrollSmoother } from "gsap/ScrollSmoother";
  import { gsap } from "gsap"

  const ua = window.navigator.userAgent;
  const iOS = !!ua.match(/iPad/i) || !!ua.match(/iPhone/i);
  const webkit = !!ua.match(/WebKit/i);
  const iOSSafari = iOS && webkit && !ua.match(/CriOS/i);

  const isIosModalOpen = atom(false);

  const requestIosPermission = () => {
    if (
      typeof DeviceMotionEvent !== "undefined" &&
      "requestPermission" in DeviceMotionEvent &&
      typeof DeviceMotionEvent.requestPermission === "function"
    ) {
      return DeviceMotionEvent.requestPermission()
    }
  }

  isIntroFinished.subscribe(async (isFinished) => {
    if (isFinished && iOSSafari && !isIosOrientationAllowed.get()) {
      
      try {
        await requestIosPermission()
      } catch {
        isIosModalOpen.set(true);
      }
    }
  });

  isIosModalOpen.subscribe(isOpen => {
    const scrollSmoother = ScrollSmoother.get();
    if (!isOpen) {
      //scrollSmoother?.paused(false);
      gsap.to("#ios-orientation-modal", {
        display: "none",
        opacity: 0,
        filter: "blur(10px)",
        scale: 0.9,
        duration: 0.5,
      });
    } else {
      isMenuVisible.set(false);
      scrollSmoother?.paused(true);
      gsap.to("#ios-orientation-modal", {
        display: "block",
        opacity: 1,
        filter: "blur(0px)",
        scale: 1,
        duration: 0.5,
      });
    }
  })

  const closeButton = document.getElementById("ios-modal-close-button");
  closeButton!.onclick = () => {
    setTimeout(() => {
      isIosModalOpen.set(false);
    }, 50);
  };

  const grantButton = document.getElementById("ios-modal-grant-button");
  grantButton!.onclick = () => {
    requestIosPermission().then((response: string) => {
          if (response === "granted") {
            window.addEventListener("deviceorientation", () => {}, false);
            setTimeout(() => {
              isIosModalOpen.set(false);
            }, 50);
          } else {
            // Handle denied permission
            console.log("Device orientation access denied");
          }
        })
        .catch(console.error);
  };
</script>

<div
  id="ios-orientation-modal"
  class="pointer-events-none text-white opacity-1 w-screen md:w-[110vw] md:-left-1/20 md:pt-[10vh] lg:pt-[10vh] xl:pt-[10vh] 2xl:pt-[15vh] -top-28 md:-top-[35vh] lg:-top-[25vh] xl:-top-[20vh] 2xl:md:-top-[18vh] z-999999 relative h-[140vh] bg-[rgba(0,0,0,0.58)] backdrop-blur-xs"
>
  <div
    class="pointer-events-auto w-full h-screen md:w-4/5 p-[2px] md:h-[80vh] md:max-w-[1282px] md:rounded-2xl flex flex-col bg-gradient-to-br from-[#2C67FF] to-transparent mx-auto"
  >
    <div
      class="pointer-events-auto w-full h-full md:max-w-[1280px] flex flex-col bg-[#0f0f0fae] md:rounded-[calc(1rem-2px)]"
    >
      <button
        id="ios-modal-close-button"
        class="self-end mb-16 text-3xl mr-8 mt-8 cursor-pointer"
      >
        X
      </button>
      <div class="-mt-8 md:-mt-16 md:mb-8 grid md:grid-cols-2">
        <h1 class="text-white mt-24 font-bold text-center text-3xl">
          Jeszcze chwilka...
        </h1>
        <p class="mx-8 text-center text-xl mt-24 font-[Chivo_Mono]">
          Wszedłeś na stronę z iPhone'a?
          <br />
          <br />
          Pozwól wykorzystać żyroskop, żeby zobaczyć mega bajer!
        </p>
        <button
          id="ios-modal-grant-button"
          class="mx-auto pt-3.5 font-safari-safe mt-16 cursor-pointer block text-white font-bold bg-[#2C67FF] rounded-xl px-8 py-2 hover:scale-110 hover:brightness-110 transition-all duration-250"
        >
          Jasne!
        </button>
      </div>
    </div>
  </div>
</div>
