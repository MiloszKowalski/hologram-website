---
import { getImage, Image } from "astro:assets";
import type { Project } from "../../../../types/portfolio";
import ThumbBg3Raw from "../../../../assets/thumb_bg_3.png";
import BlueSpotlight from "../../../../assets/blue_spotlight.png";
import { projects } from "../projects";

const ThumbBg3 = await getImage({ src: ThumbBg3Raw, format: "avif" });

interface Props {
  project: Project;
}

const { project } = Astro.props;

const imported = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/projects/**/miniatura.{jpeg,jpg,png,gif}"
);

const getOptimizedThumbnail = async () => {
  for (const [path, imagePromise] of Object.entries(imported)) {
    if (!path.includes(project.thumbSrc)) {
      continue;
    }

    const importedImage = await imagePromise();
    const image = importedImage.default;
    return await getImage({ src: image, format: "avif", width: 680 });
  }

  return null;
};

const optimizedThumbnail = (await getOptimizedThumbnail())!;

const id = `card-c-${project.name.replace(" ", "")}`;
---

<script>
  import { isModalOpen, modalContents } from "../../store/animationStore";

  class CardC extends HTMLElement {
    connectedCallback() {
      this.addEventListener("click", () => {
        modalContents.set(JSON.parse(this.dataset.project!));
        isModalOpen.set(true);
      });
    }
  }

  customElements.define("card-c", CardC);
</script>
<card-c id={id} data-project={JSON.stringify(project)} class="relative">
  {
      (projects.findIndex((x) => x.name === project.name) - 2) % 15 === 0 && (
        <Image
          src={BlueSpotlight}
          alt=""
          class="opacity-25 absolute md:-left-1/3 -top-5/3 md:-top-5/2 rotate-150 md:rotate-112 scale-125 md:-z-1"
          format="avif"
          loading="lazy"
        />
      )
    }
  <article
    data-speed="1"
    style={{
      backgroundImage: `url(${ThumbBg3.src})`,
      backgroundSize: "cover",
    }}
    class="my-4 md:my-0 cursor-pointer p-4 group mr-auto rounded-2xl w-19/20 mx-auto md:mx-0 md:w-1/2 h-auto relative md:-top-64 z-9"
  >
    

    <div
      class="absolute w-4/5 top-[93%] text-shadow-lg text-white md:top-[97%] left-1/6 last:left-1/32 md:left-1/5 z-20"
    >
      <h3
        class="my-0 text-xl md:text-2xl text-shadow-black-900 text-shadow-[3px_32px_0px_3px_black] font-bold"
      >
        {project.name}
      </h3>
      <h4
        class="-mt-1 text-sm md:text-base text-shadow-md text-shadow-black-500 font-[Chivo_Mono]"
      >
        {project.clientName}
      </h4>
    </div>
    <div
      class={`relative w-full h-full bg-no-repeat rounded-xl group-hover:scale-95 transition-transform duration-750 ease-out`}
    >
      <img
        class="block rounded-xl w-full aspect-video"
        crossorigin="anonymous"
        src={optimizedThumbnail.src}
        srcset={optimizedThumbnail.srcSet.attribute}
        loading="lazy"
        decoding="async"
        alt=""
      />
    </div>
  </article>
</card-c>
